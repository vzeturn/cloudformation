â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  COMPLETE USAGE GUIDE - MODULAR CLOUDFORMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OVERVIEW
--------
This modular structure splits your infrastructure into 6 stages
for better maintainability, faster updates, and safer rollbacks.

QUICK START (5 STEPS)
=====================

STEP 1: CREATE DIRECTORY STRUCTURE
-----------------------------------
mkdir -p cloudformation/{1-foundation,2-security/parameters,3-infrastructure/parameters,4-compute/parameters,5-cicd/parameters,6-monitoring/parameters,scripts}

STEP 2: COPY ALL ARTIFACTS
---------------------------
Copy each artifact from this conversation to its corresponding file.
See FILE-INDEX.txt for complete list.

Example:
- Copy artifact "secrets-manager" â†’ 2-security/secrets-manager.yaml
- Copy artifact "ecs-cluster" â†’ 4-compute/ecs-cluster.yaml
- Copy artifact "cleanup-script" â†’ scripts/cleanup.sh

STEP 3: UPDATE PARAMETERS
--------------------------
Edit these parameter files with YOUR actual values:

3-infrastructure/parameters/infra-prod.json:
  - VpcId: Your VPC ID
  - PublicSubnet1, PublicSubnet2: Your public subnet IDs
  - CertificateArn: Your ACM certificate ARN (or leave empty)

4-compute/parameters/compute-prod.json:
  - VpcId: Your VPC ID
  - PrivateSubnet1, PrivateSubnet2: Your private subnet IDs

5-cicd/parameters/cicd-prod.json:
  - GitHubConnectionArn: Your GitHub connection ARN
  - GitHubRepoFrontend: your-org/frontend-repo
  - GitHubRepoBackend: your-org/backend-repo

6-monitoring/parameters/monitoring-prod.json:
  - AlertEmail: your-email@example.com

STEP 4: MAKE SCRIPTS EXECUTABLE
--------------------------------
cd cloudformation/scripts
chmod +x *.sh

STEP 5: DEPLOY!
---------------
# Validate first
./validate-all.sh

# Deploy all stages
./deploy-all.sh \
  --project aqua-sample-app \
  --environment production \
  --region ap-southeast-1

# Or deploy development (skip optional stages)
./deploy-all.sh \
  --project aqua-sample-app \
  --environment development \
  --skip-stage 5 \
  --skip-stage 6

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  DEPLOYMENT SCENARIOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCENARIO 1: FULL PRODUCTION DEPLOYMENT
---------------------------------------
Time: 25-38 minutes
Cost: ~$120-160/month

./deploy-all.sh \
  --project myapp \
  --environment production

Deploys:
âœ“ Stage 1: Foundation (KMS, Logs)
âœ“ Stage 2: Security (IAM Roles)
âœ“ Stage 3: Infrastructure (ECR, S3, ALB, WAF)
âœ“ Stage 4: Compute (ECS Cluster & Services)
âœ“ Stage 5: CI/CD (CodePipeline)
âœ“ Stage 6: Monitoring (Dashboards, Alarms)

SCENARIO 2: DEVELOPMENT ENVIRONMENT
------------------------------------
Time: 18-28 minutes
Cost: ~$70-90/month

./deploy-all.sh \
  --project myapp \
  --environment development \
  --skip-stage 5 \
  --skip-stage 6

Deploys:
âœ“ Stage 1-4 (Core infrastructure)
âœ— Stage 5-6 (Optional features)

SCENARIO 3: UPDATE ONLY IAM ROLES
----------------------------------
Time: 2-3 minutes (fast!)

./deploy-single.sh \
  --stack myapp-production-iam \
  --template ../2-security/iam-roles.yaml \
  --parameters ../2-security/parameters/iam-prod.json \
  --capabilities CAPABILITY_NAMED_IAM

SCENARIO 4: UPDATE ONLY ECS SERVICES
-------------------------------------
Time: 5-8 minutes

./deploy-single.sh \
  --stack myapp-production-services \
  --template ../4-compute/ecs-services.yaml \
  --parameters ../4-compute/parameters/compute-prod.json

SCENARIO 5: ADD MONITORING TO EXISTING DEPLOYMENT
--------------------------------------------------
Time: 3-5 minutes

# Deploy SNS topics
./deploy-single.sh \
  --stack myapp-production-sns \
  --template ../6-monitoring/sns-topics.yaml \
  --parameters ../6-monitoring/parameters/monitoring-prod.json

# Deploy alarms
./deploy-single.sh \
  --stack myapp-production-alarms \
  --template ../6-monitoring/cloudwatch-alarms.yaml \
  --parameters ../6-monitoring/parameters/monitoring-prod.json

# Deploy dashboards
./deploy-single.sh \
  --stack myapp-production-dashboards \
  --template ../6-monitoring/cloudwatch-dashboards.yaml \
  --parameters ../6-monitoring/parameters/monitoring-prod.json

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ERROR: "Export not found"
-------------------------
Cause: Previous stage not deployed
Solution: Deploy stages in order (1â†’2â†’3â†’4â†’5â†’6)

ERROR: "IAM role does not exist"
--------------------------------
Cause: Stage 2 (Security) not deployed
Solution:
  ./deploy-all.sh --only-stage 2

ERROR: "Template validation failed"
-----------------------------------
Cause: Syntax error in YAML
Solution:
  ./validate-all.sh
  # Fix reported errors

ERROR: ECS Tasks not starting
------------------------------
Possible causes:
1. Missing IAM roles â†’ Deploy Stage 2
2. Missing secrets â†’ Update secrets in AWS Console
3. Missing ECR images â†’ Push Docker images
4. Wrong network config â†’ Check VPC/subnets

Check logs:
  aws logs tail /ecs/myapp-production/backend --follow

ERROR: "Stack in invalid state"
-------------------------------
Cause: Previous deployment failed
Solution:
  # Check stack status
  aws cloudformation describe-stacks --stack-name STACK_NAME
  
  # If ROLLBACK_COMPLETE, delete and retry
  aws cloudformation delete-stack --stack-name STACK_NAME
  
  # Wait and redeploy
  ./deploy-all.sh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MAINTENANCE OPERATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UPDATE SINGLE COMPONENT
-----------------------
# Fast: Updates only what changed
./deploy-single.sh --stack STACK_NAME --template TEMPLATE

ROLLBACK DEPLOYMENT
-------------------
# Rollback everything
./rollback.sh --project myapp --environment production

# Rollback from specific stage
./rollback.sh --project myapp --environment production --stage 4

VALIDATE BEFORE DEPLOY
-----------------------
# Always validate first!
./validate-all.sh

COMPLETE CLEANUP
----------------
# Delete everything (IRREVERSIBLE!)
./cleanup.sh --project myapp --environment production

VIEW LOGS
---------
# Backend logs
aws logs tail /ecs/myapp-production/backend --follow

# Frontend logs
aws logs tail /ecs/myapp-production/frontend --follow

# Build logs
aws logs tail /aws/codebuild/myapp-production-backend --follow

CHECK SERVICE STATUS
--------------------
aws ecs describe-services \
  --cluster myapp-production-Cluster \
  --services myapp-production-backend-svc \
  --query 'services[0].{Status:status,Running:runningCount,Desired:desiredCount}'

VIEW CLOUDWATCH DASHBOARD
-------------------------
https://console.aws.amazon.com/cloudwatch/home?region=ap-southeast-1#dashboards:name=myapp-production-dashboard

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  BEST PRACTICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Always validate before deploying
âœ“ Deploy to dev first, then staging, then production
âœ“ Use change sets for production updates
âœ“ Tag all resources consistently
âœ“ Monitor costs regularly
âœ“ Review CloudWatch logs daily
âœ“ Update secrets outside of CloudFormation
âœ“ Keep parameters in version control (without secrets!)
âœ“ Document any manual changes
âœ“ Test rollback procedures regularly

âœ— Don't skip validation
âœ— Don't deploy directly to production
âœ— Don't commit secrets to git
âœ— Don't delete stacks manually (use scripts)
âœ— Don't modify resources outside CloudFormation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  COST OPTIMIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Development Environment
-----------------------
Skip: CI/CD (Stage 5), Monitoring (Stage 6)
Use: Fargate Spot, smaller tasks
Cost: ~$70-90/month (save 30-40%)

Production Environment
----------------------
Full: All 6 stages
Use: Fargate + Spot mix, proper sizing
Cost: ~$120-160/month

Tips to reduce costs:
- Use Fargate Spot for non-critical tasks
- Right-size CPU/memory allocations
- Enable S3 lifecycle policies
- Use CloudWatch log retention
- Delete unused ECR images
- Schedule dev environment downtime

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  NEXT STEPS AFTER DEPLOYMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. PUSH DOCKER IMAGES
   - Build your frontend/backend images
   - Push to ECR repositories
   - ECS will auto-deploy

2. UPDATE SECRETS
   - Go to AWS Secrets Manager
   - Update placeholder values with real secrets
   - Restart ECS services

3. CONFIGURE DNS
   - Point your domain to ALB DNS name
   - Or use Route53 alias record

4. SETUP GITHUB WEBHOOKS (for CI/CD)
   - Configure GitHub connection
   - Test pipeline with a commit

5. SUBSCRIBE TO ALERTS
   - Check email for SNS confirmation
   - Configure Slack/PagerDuty if needed

6. MONITOR & OPTIMIZE
   - Watch CloudWatch dashboards
   - Review cost reports
   - Tune auto-scaling thresholds

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Good luck with your deployment! ğŸš€

For issues or questions, check:
- CloudFormation events in AWS Console
- CloudWatch logs
- This USAGE-GUIDE.txt
- FILE-INDEX.txt for file locations

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•